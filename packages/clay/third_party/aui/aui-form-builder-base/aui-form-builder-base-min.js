YUI.add("aui-form-builder-base",function(e,t){var n=e.Lang,r=n.isArray,i=n.isBoolean,s=n.isObject,o=n.isString,u=e.Array,a=e.AvailableField.getAvailableFieldById,f=function(t){return t instanceof e.AvailableField},l=function(t){return t instanceof e.FormBuilderField},c=e.getClassName,h="availableFields_field_",p="fields_field_",d=c("dd","dragging"),v=c("diagram","builder","field","draggable"),m=c("form","builder","field","hover"),g=c("form","builder","drop","zone"),y=c("form","builder","field"),b=c("form","builder","placeholder"),w='<div class="'+b+'"></div>',E=e.Component.create({NAME:"availableField",ATTRS:{hiddenAttributes:{validator:r},name:{},options:{validator:s},predefinedValue:{},readOnlyAttributes:{validator:r},required:{validator:i},showLabel:{validator:i,value:!0},tip:{validator:o},unique:{validator:i},width:{}},EXTENDS:e.AvailableField});e.FormBuilderAvailableField=E;var S=e.Component.create({NAME:"form-builder",ATTRS:{allowRemoveRequiredFields:{validator:i,value:!1},enableEditing:{value:!0},fieldsSortableListConfig:{setter:"_setFieldsSortableListConfig",validator:s,value:null},strings:{value:{addNode:"Add field",close:"Close",propertyName:"Property Name",save:"Save",settings:"Settings",value:"Value"}}},UI_ATTRS:["allowRemoveRequiredFields"],EXTENDS:e.DiagramBuilderBase,FIELDS_TAB:0,SETTINGS_TAB:1,prototype:{selectedFieldsLinkedSet:null,uniqueFieldsMap:null,initializer:function(){var t=this;t.selectedFieldsLinkedSet=new e.LinkedSet({after:{add:e.bind(t._afterSelectedFieldsSetAdd,t),remove:e.bind(t._afterSelectedFieldsSetRemove,t)}}),t.uniqueFieldsMap=new e.Map({after:{put:e.bind(t._afterUniqueFieldsMapPut,t),remove:e.bind(t._afterUniqueFieldsMapRemove,t)}}),t.on({cancel:t._onCancel,"drag:end":t._onDragEnd,"drag:start":t._onDragStart,"drag:mouseDown":t._onDragMouseDown,save:t._onSave}),t.after("*:focusedChange",t._afterFieldFocusedChange),t.dropContainer.delegate("click",e.bind(t._onClickField,t),"."+y),t.dropContainer.delegate("mouseover",e.bind(t._onMouseOverField,t),"."+y),t.dropContainer.delegate("mouseout",e.bind(t._onMouseOutField,t),"."+y)},syncUI:function(){var e=this;e._setupAvailableFieldsSortableList(),e._setupFieldsSortableList()},closeEditProperties:function(){var t=this;t.tabView.selectChild(e.FormBuilder.FIELDS_TAB),t.tabView.disableTab(e.FormBuilder.SETTINGS_TAB)},createField:function(t){var n=this,r={builder:n,parent:n};return l(t)?t.setAttrs(r):(e.each(t,function(e,n){e===undefined&&delete t[n]}),t=new(n.getFieldClass(t.type||"field"))(e.mix(r,t))),t.addTarget(n),t},duplicateField:function(e){var t=this,n=t._getFieldNodeIndex(e.get("boundingBox")),r=t._cloneField(e,!0),i=r.get("boundingBox");i.setStyle("opacity",0),t.insertField(r,++n,e.get("parent")),i.show(!0)},editField:function(e){var t=this;l(e)&&(t.editingField=e,t.unselectFields(),t.selectFields(e))},getFieldClass:function(t){var n=e.FormBuilder.types[t];return n?n:(e.log("The field type: ["+t+"] couldn't be found."),null)},getFieldProperties:function(e,t){return e.getProperties(t)},insertField:function(e,t,n){var r=this;n=n||r,e.get("parent").removeField(e),n.addField(e,t)},openEditProperties:function(t){var n=this;n.tabView.enableTab(e.FormBuilder.SETTINGS_TAB),n.tabView.selectChild(e.FormBuilder.SETTINGS_TAB),n.propertyList.set("data",n.getFieldProperties(t,!0))},plotField:function(e,t){var n=this,r=e.get("boundingBox");e.get("rendered")?t.append(r):e.render(t),n._syncUniqueField(e),n.fieldsSortableList.add(r)},plotFields:function(t,n){var r=this;n=n||r.dropContainer,t=t||r.get("fields"),n.setContent(""),e.each(t,function(e){r.plotField(e,n)})},selectFields:function(e){var t=this,n=t.selectedFieldsLinkedSet;u.each(u(e),function(e){n.add(e)})},simulateFocusField:function(e){var t=this,n=t.lastFocusedField;n&&n.blur(),t.lastFocusedField=e.focus()},unselectFields:function(e){var t=this,n=t.selectedFieldsLinkedSet;e||(e=n.values()),u.each(u(e),function(e){n.remove(e)})},_afterFieldFocusedChange:function(e){var t=this,n=e.target;e.newVal&&l(n)&&t.editField(n)},_afterUniqueFieldsMapPut:function(e){var t=a(e.key),n;f(t)&&(n=t.get("node"),t.set("draggable",!1),n.unselectable())},_afterUniqueFieldsMapRemove:function(e){var t=a(e.key),n;f(t)&&(n=t.get("node"),t.set("draggable",!0),n.selectable())},_afterSelectedFieldsSetAdd:function(e){var t=this;e.value.set("selected",!0),t.openEditProperties(e.value)},_afterSelectedFieldsSetRemove:function(e){var t=this;e.value.set("selected",!1),t.closeEditProperties()},_cloneField:function(t,n){var r=this,i=t.getAttributesForCloning();return n&&(i.fields=[],e.each(t.get("fields"),function(e,t){e.get("unique")||(i.fields[t]=r._cloneField(e,n))})),r.createField(i)},_dropField:function(t){var n=this,r=t.getData("availableField"),i=e.Widget.getByNode(t);if(f(r)){var s={hiddenAttributes:r.get("hiddenAttributes"),label:r.get("label"),localizationMap:r.get("localizationMap"),options:r.get("options"),predefinedValue:r.get("predefinedValue"),readOnlyAttributes:r.get("readOnlyAttributes"),required:r.get("required"),showLabel:r.get("showLabel"),tip:r.get("tip"),type:r.get("type"),unique:r.get("unique"),width:r.get("width")};s.unique&&(s.id=n._getFieldId(r),s.name=r.get("name")),i=n.createField(s)}if(l(i)){var o=t.get("parentNode"),u=e.Widget.getByNode(o),a=n._getFieldNodeIndex(t);l(u)||(u=n),n.insertField(i,a,u)}},_getFieldId:function(e){var t=e.get("id"),n;return f(e)?n=h:n=p,t.replace(n,"")},_getFieldNodeIndex:function(e){return e.get("parentNode").all("> *:not(."+b+")").indexOf(e)},_onCancel:function(e){var t=this;t.unselectFields(),e.halt()},_onDragEnd:function(t){var n=this,r=t.target,i=r.get("node");n._dropField(i),l(e.Widget.getByNode(i))||(i.remove(),r.set("node",n._originalDragNode))},_onClickField:function(t){var n=this,r=e.Widget.getByNode(t.target);n.simulateFocusField(r),t.stopPropagation()},_onDragMouseDown:function(t){var n=t.target.get("node"),r=e.AvailableField.getAvailableFieldByNode(n);f(r)&&!r.get("draggable")&&t.halt()},_onDragStart:function(t){var n=this,r=t.target
,i=r.get("node");if(l(e.Widget.getByNode(i)))return;n._originalDragNode=i;var s=i.clone();i.placeBefore(s),r.set("node",s);var o=i.getData("availableField");s.setData("availableField",o),s.attr("id",""),s.hide(),i.removeClass(d),i.show(),n.fieldsSortableList.add(s)},_onMouseOutField:function(t){var n=e.Widget.getByNode(t.currentTarget);n.controlsToolbar.hide(),n.get("boundingBox").removeClass(m),t.stopPropagation()},_onMouseOverField:function(t){var n=e.Widget.getByNode(t.currentTarget);n.controlsToolbar.show(),n.get("boundingBox").addClass(m),t.stopPropagation()},_onSave:function(){var e=this,t=e.editingField;if(t){var n=e.propertyList.get("data");n.each(function(e){t.set(e.get("attributeName"),e.get("value"))}),e._syncUniqueField(t)}},_setAvailableFields:function(t){var n=[];return u.each(t,function(t){n.push(f(t)?t:new e.FormBuilderAvailableField(t))}),n},_setFieldsSortableListConfig:function(t){var n=this,r=n.dropContainer;return e.merge({bubbleTargets:n,dd:{groups:["availableFields"],plugins:[{cfg:{horizontal:!1,scrollDelay:150},fn:e.Plugin.DDWinScroll}]},dropCondition:function(t){var n=t.drop.get("node"),r=e.Widget.getByNode(n);return l(r)?!0:!1},placeholder:e.Node.create(w),dropOn:"."+g,sortCondition:function(e){var t=e.drop.get("node");return t!==n.dropContainer&&r.contains(t)}},t||{})},_setupAvailableFieldsSortableList:function(){var t=this;if(!t.availableFieldsSortableList){var n=t.fieldsContainer.all("."+v);t.availableFieldsSortableList=new e.SortableList(e.merge(t.get("fieldsSortableListConfig"),{nodes:n}))}},_setupFieldsSortableList:function(){var t=this;t.fieldsSortableList||(t.fieldsSortableList=new e.SortableList(t.get("fieldsSortableListConfig")))},_syncUniqueField:function(e){var t=this,n=t._getFieldId(e),r=a(n);f(r)&&(r.get("unique")||e.get("unique"))&&t.uniqueFieldsMap.put(n,e)},_uiSetAllowRemoveRequiredFields:function(){var e=this;e.get("fields").each(function(e){e._uiSetRequired(e.get("required"))})}}});e.FormBuilder=S,e.FormBuilder.types={}},"2.5.0",{requires:["escape","transition","aui-button","aui-collection","aui-diagram-builder-base","aui-sortable-list","aui-tabview"],skinnable:!0});
