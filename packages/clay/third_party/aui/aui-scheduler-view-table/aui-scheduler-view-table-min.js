YUI.add("aui-scheduler-view-table",function(e,t){var n=e.Lang,r=n.isFunction,i=n.isString,s=e.DataType.DateMath,o=e.WidgetStdMod,u=s.WEEK_LENGTH,a=function(e,t){return function(n){var r=n.all(e);return r.size()>=t?r:null}},f=e.getClassName,l=f("icon"),c=f("icon","arrowstop-1-l"),h=f("icon","arrowstop-1-r"),p=f("scheduler-view","table","colgrid"),d=f("scheduler-view","table","colgrid","first"),v=f("scheduler-view","table","colgrid","today"),m=f("scheduler-view","table","container"),g=f("scheduler-view","table","events","overlay","node"),y=f("scheduler-view","table","events","overlay","node","body"),b=f("scheduler-view","table","events","overlay","node","close"),w=f("scheduler-view","table","header","col"),E=f("scheduler-view","table","header","day"),S=f("scheduler-view","table","header","table"),x=f("scheduler-view","table","more"),T=f("scheduler-view","table","row"),N=f("scheduler-view","table","row","container"),C=f("scheduler-view","table","data"),k=f("scheduler-view","table","data","col"),L=f("scheduler-view","table","data","col","title"),A=f("scheduler-view","table","data","col","title","down"),O=f("scheduler-view","table","data","col","title","first"),M=f("scheduler-view","table","data","col","title","next"),_=f("scheduler-view","table","data","col","title","today"),D=f("scheduler-view","table","data","event"),P=f("scheduler-view","table","data","event","left"),H=f("scheduler-view","table","data","event","right"),B=f("scheduler-view","table","data","first"),j=f("scheduler-view","table","grid"),F=f("scheduler-view","table","grid","first"),I='<div class="'+m+'">'+'<div class="'+N+'"></div>'+"</div>",q='<div class="'+g+'">'+'<div class="'+y+'"></div>'+'<a href="javascript:;" class="'+b+'">{label}</a>'+"</div>",R='<td class="'+p+'">&nbsp;</td>',U='<th class="'+E+'"><div>&nbsp;</div></th>',z='<table cellspacing="0" cellpadding="0" class="'+S+'">'+"<tbody>"+'<tr class="'+w+'"></tr>'+"</tbody>"+"</table>",W='<a href="javascript:;" class="'+x+'">{labelPrefix} {count} {labelSuffix}</a>',X='<div class="'+T+'" style="top: {top}%; height: {height}%;"></div>',V='<table cellspacing="0" cellpadding="0" class="'+C+'">'+"<tbody></tbody>"+"</table>",$='<table cellspacing="0" cellpadding="0" class="'+j+'">'+"<tbody>"+"<tr></tr>"+"</tbody>"+"</table>",J='<span class="'+[l,c].join(" ")+'"></span>',K='<span class="'+[l,h].join(" ")+'"></span>',Q='<td class="'+k+'"><div></div></td>',G="<tr></tr>",Y=e.Component.create({NAME:"scheduler-view-table",ATTRS:{bodyContent:{value:""},displayDaysInterval:{value:42},displayRows:{value:3},fixedHeight:{value:!0},name:{value:"table"},headerDateFormatter:{value:function(t){var n=this,r=n.get("scheduler");return e.DataType.Date.format(t,{format:"%a",locale:r.get("locale")})},validator:i},navigationDateFormatter:{value:function(t){var n=this,r=n.get("scheduler");return e.DataType.Date.format(t,{format:"%b %Y",locale:r.get("locale")})},validator:r},scrollable:{value:!1},strings:{value:{close:"Close",show:"Show",more:"more"}},headerTableNode:{valueFn:function(){return e.Node.create(z)}},colHeaderDaysNode:{valueFn:"_valueColHeaderDaysNode"},rowsContainerNode:{valueFn:function(){return e.Node.create(I)}},tableGridNode:{valueFn:"_valueTableGridNode"}},HTML_PARSER:{colHeaderDaysNode:a("."+E,7),headerTableNode:"."+S,rowsContainerNode:"."+m,tableGridNode:a("."+j,7)},EXTENDS:e.SchedulerView,prototype:{evtDateStack:null,evtRenderedStack:null,rowDataTableStack:null,initializer:function(){var t=this;t.evtDateStack={},t.evtRenderedStack={},t.rowDataTableStack={},t.colHeaderDaysNode=t.get("colHeaderDaysNode"),t.headerTableNode=t.get("headerTableNode"),t.rowsContainerNode=t.get("rowsContainerNode"),t.tableGridNode=t.get("tableGridNode"),t.columnDayHeader=t.headerTableNode.one("."+w),t.columnTableGrid=e.NodeList.create(),t.tableRowContainer=t.rowsContainerNode.one("."+N),t.tableRows=e.NodeList.create()},bindUI:function(){var t=this;t.rowsContainerNode.delegate("click",e.bind(t._onClickMore,t),"."+x)},renderUI:function(){var e=this,t=e._getDisplayRowsCount(),n;for(n=0;n<t;n++)e.tableRows.push(e.buildGridRowNode(n));e._renderEventsOverlay(),e.colHeaderDaysNode.appendTo(e.columnDayHeader),e.tableRows.appendTo(e.tableRowContainer)},buildEventsRow:function(t,r,i){var s=this,o=s.get("displayRows"),u=0,a=e.Node.create(G);return s.loopDates(t,r,function(f,l){if(u>l)return;var c=s.getIntersectEvents(f),h=s._getRenderableEvent(c,t,r,f),p=e.Node.create(Q),d=p.one("div");if(o<c.length&&i===o-1){var v=s.get("strings"),m=e.Node.create(n.sub(W,{count:c.length-(o-1),labelPrefix:v.show,labelSuffix:v.more}));m.setData("events",c),d.append(m)}else if(h){var g=s._getEvtSplitInfo(h,f,t,r);p.attr("colspan",g.colspan),u+=g.colspan-1,s._syncEventNodeContainerUI(h,d,g),s._syncEventNodeUI(h,d,f);var y=String(f.getTime());s.evtRenderedStack[y].push(h)}u++,a.append(p)}),a},buildEventsTable:function(t,n){var r=this,i=r.get("displayRows"),o=s.clearTime(r._findCurrentIntervalStart()),u=String(o.getTime()).concat(t.getTime()).concat(n.getTime()),a=r.rowDataTableStack[u],f;if(!a){a=e.Node.create(V);var l=a.one("tbody"),c=r.buildEventsTitleRow(a,t,n);l.append(c);for(f=0;f<i;f++){var h=r.buildEventsRow(t,n,f);l.append(h)}r.rowDataTableStack[u]=a}return a},buildEventsTitleRow:function(t,n,r){var i=this,o=i.get("scheduler").get("todayDate"),u=e.Node.create(G);return i.loopDates(n,r,function(t,n){var r=e.Node.create(Q);r.addClass(L).toggleClass(O,n===0).toggleClass(_,!s.isDayOverlap(t,o)).toggleClass(M,!s.isDayOverlap(s.subtract(t,s.DAY,1),o)).toggleClass(A,!s.isDayOverlap(s.subtract(t,s.WEEK,1),o)),u.append(r.setContent(t.getDate()))}),u},buildGridRowNode:function(t){var r=this,i=r._getDisplayRowsCount(),s=100/i,o=r._getTableGridNode(t),u=e.Node.create(n.sub(X,{height:s,top:s*t}));return u.append(o.toggleClass(F,t===0)),u},flushViewCache:function(){var e=this;e.evtDateStack={},e.evtRenderedStack={},e.rowDataTableStack={}},getIntersectEvents:function(t){var n=this,r=n.get("scheduler"),i=String(t.getTime());if(!n.evtDateStack[
i]){var s=r.getIntersectEvents(t);n.evtDateStack[i]=e.Array.filter(s,n.get("filterFn"))}return n.evtDateStack[i]},getNextDate:function(){var e=this,t=e.get("scheduler"),n=t.get("viewDate"),r=e.get("displayDaysInterval");return s.toLastHour(s.add(n,s.DAY,r))},getPrevDate:function(){var e=this,t=e.get("scheduler"),n=t.get("viewDate"),r=e.get("displayDaysInterval");return s.toMidnight(s.subtract(n,s.DAY,r))},hideEventsOverlay:function(){var e=this;e.eventsOverlay.set("visible",!1)},loopDates:function(e,t,n,r,i){var o=this,u=s.clone(e),a=t.getTime(),f;for(f=0;u.getTime()<=a;f++)n.apply(o,[u,f]),u=s.add(u,r||s.DAY,i||1)},plotEvents:function(){var e=this,t=e._findCurrentIntervalStart(),n=s.safeClearTime(t);e.flushViewCache(),e.hideEventsOverlay(),e.bodyNode.all("."+C).remove();var r=e.get("displayDaysInterval"),i=Math.min(r,u);e.tableRows.each(function(t,r){var o=s.add(n,s.DAY,i*r),u=s.add(o,s.DAY,i-1),a=e.buildEventsTable(o,u);r===0&&a.addClass(B),t.append(a)})},syncDaysHeaderUI:function(){var e=this,t=e.get("scheduler"),n=t.get("viewDate"),r=e.get("headerDateFormatter"),i=e._findFirstDayOfWeek(n);e.colHeaderDaysNode.all("div").each(function(t,n){var o=s.add(i,s.DAY,n);t.html(r.call(e,o))})},syncGridUI:function(){var e=this,t=e.get("scheduler"),n=t.get("todayDate");e.columnTableGrid.removeClass(v);var r=e._findCurrentIntervalStart(),i=e._findCurrentIntervalEnd();if(s.between(n,r,i)){var o=t.get("firstDayOfWeek"),u=e._findFirstDayOfWeek(n),a=s.getWeekNumber(n,o)-s.getWeekNumber(r,o),f=n.getDate()-u.getDate(),l=e._getCellIndex([f,a]),c=e.columnTableGrid.item(l);c&&c.addClass(v)}},syncStdContent:function(){var e=this;e.setStdModContent(o.BODY,e.rowsContainerNode.getDOM()),e.setStdModContent(o.HEADER,e.headerTableNode.getDOM())},_findCurrentIntervalEnd:function(){var e=this,t=e.get("scheduler"),n=t.get("viewDate"),r=e.get("displayDaysInterval");return s.add(n,s.DAY,r)},_findCurrentIntervalStart:function(){var e=this,t=e.get("scheduler");return t.get("viewDate")},_findFirstDayOfWeek:function(e){var t=this,n=t.get("scheduler"),r=n.get("firstDayOfWeek");return s.getFirstDayOfWeek(e,r)},_getCellIndex:function(e){return e[1]*u+e[0]},_getDisplayRowsCount:function(){var e=this,t=e.get("displayDaysInterval");return Math.ceil(t/u)},_getDisplayRowDaysCount:function(){var e=this,t=e.get("displayDaysInterval");return Math.min(t,u)},_getEvtLabel:function(e){var t=e.get("endDate"),n=e.get("startDate");return[n.getHours(),"-",t.getHours()," ",e.get("content")].join("")},_getEvtSplitInfo:function(e,t,n,r){var i=e.getClearStartDate(),o=e.getClearEndDate(),u=s.getDayOffset(r,t),a={colspan:Math.min(s.getDayOffset(o,t),u)+1,left:s.before(i,n),right:s.after(o,r)};return a},_getRenderableEvent:function(t,n,r,i){var o=this,u=String(i.getTime()),a;o.evtRenderedStack[u]||(o.evtRenderedStack[u]=[]);for(a=0;a<t.length;a++){var f=t[a],l=f.get("startDate"),c=s.after(i,l)&&!s.isDayOverlap(i,n),h=!s.isDayOverlap(l,i),p=e.Array.indexOf(o.evtRenderedStack[u],f)>-1;if(!p&&(h||c))return f}return null},_getTableGridNode:function(t){var n=this,r=n.get("displayDaysInterval"),i=n.tableGridNode.item(t),s=i.one("tr"),o;for(o=0;o<Math.min(r,u);o++){var a=e.Node.create(R);s.append(a),o===0&&a.addClass(d),n.columnTableGrid.push(a)}return i},_onClickMore:function(t){var n=this,r=t.target,i=r.getData("events"),s=e.NodeList.create();e.Array.each(i,function(e){var t=e.get("node").item(0).clone();t.setData("scheduler-event",e),t.setStyles({height:"auto",left:0,position:"relative",top:0,width:"auto"}),s.push(t)}),n.eventsOverlay.bodyNode.one("."+y).setContent(s),n.eventsOverlay.setAttrs({visible:!0,xy:r.getXY()})},_renderEventsOverlay:function(){var t=this,r=t.get("strings");t.eventsOverlay=new e.Overlay({align:{points:["tl","tl"]},bodyContent:n.sub(q,{label:r.close}),render:t.get("boundingBox"),visible:!1,width:250,zIndex:450}),t.eventsOverlay.bodyNode.delegate("click",e.bind(t.hideEventsOverlay,t),"."+b)},_syncEventNodeContainerUI:function(e,t,n){t.addClass(D),n.left&&t.addClass(P).prepend(J),n.right&&t.addClass(H).append(K)},_syncEventNodeUI:function(e,t,n){var r=this,i=r.get("scheduler"),o=i.get("firstDayOfWeek"),a=e.get("node"),f=e.get("startDate"),l=s.clearTime(r._findCurrentIntervalStart()),c=s.getFirstDayOfWeek(new Date(Math.max(f,l)),o),h=Math.floor(s.getDayOffset(n,c)/u);a.size()<=h&&e.addPaddingNode();var p=a.item(h);p.setStyles({height:"auto",left:0,top:0,width:"auto"}),p.appendTo(t),e.syncUI()},_uiSetDate:function(){var e=this;e.syncDaysHeaderUI(),e.syncGridUI()},_valueColHeaderDaysNode:function(){var e=this,t=e.get("displayDaysInterval"),n=Math.min(t,u);return e._valueNodeList(n,U)},_valueTableGridNode:function(){var e=this,t=e.get("displayDaysInterval"),n=Math.min(t,u);return e._valueNodeList(n,$)},_valueNodeList:function(t,n){var r=[];while(t--)r.push(n);return e.NodeList.create(r.join(""))}}});e.SchedulerTableView=Y},"2.5.0",{requires:["overlay","aui-scheduler-base"],skinnable:!0});
