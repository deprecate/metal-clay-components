YUI.add("aui-scheduler-view-day",function(e,t){var n=e.Lang,r=n.isBoolean,i=n.isFunction,s=n.isNumber,o=n.isObject,u=n.isString,a=e.DataType.DateMath,f=e.WidgetStdMod,l=e.cached(function(){var t=e.config.doc,n=t.createElement("div"),r=t.getElementsByTagName("body")[0],i=.1;return r&&(n.style.cssText="position:absolute;visibility:hidden;overflow:scroll;width:20px;",n.appendChild(t.createElement("p")).style.height="1px",r.insertBefore(n,r.firstChild),i=n.offsetWidth-n.clientWidth,r.removeChild(n)),i},null,.1),c=function(e,t){return function(n){var r=n.all(e);return r.size()>=t?r:null}},h=function(e,t){return Math.round(e/t)*t},p=function(e){return parseFloat(e)||0},d=e.getClassName,v=d("scheduler-view","table","data"),m=d("scheduler-event"),g=d("scheduler-event","disabled"),y=d("scheduler-event","proxy"),b=d("scheduler","today"),w=d("scheduler","today","hd"),E=d("scheduler-view","coldata"),S=d("scheduler-view","colgrid"),x=d("scheduler-view","grid"),T=d("scheduler-view","grid","container"),N=d("scheduler-view","day","header","col"),C=d("scheduler-view","day","header","day"),k=d("scheduler-view","day","header","day","first"),L=d("scheduler-view","day","header","table"),A=d("scheduler-view","day","header","view","label"),O=d("scheduler-view","icon","grip","horizontal"),M=d("scheduler-view","marker","division"),_=d("scheduler-view","markercell"),D=d("scheduler-view","markers"),P=d("scheduler-view","day","resizer"),H=d("scheduler-view","day","resizer","icon"),B=d("scheduler-view","day","table"),j=d("scheduler-view","day","table","col"),F=d("scheduler-view","day","table","col","shim"),I=d("scheduler-view","day","table","colblank"),q=d("scheduler-view","day","table","colday"),R=d("scheduler-view","day","table","coltime"),U=d("scheduler-view","day","table","time"),z='<div class="'+P+'">'+'<div class="'+[O,H].join(" ")+'"></div>'+"</div>",W='<div class="'+_+'">'+'<div class="'+M+'"></div>'+"</div>",X='<span class="'+A+'">{label}</span>',V='<table cellspacing="0" cellpadding="0" class="'+B+'">'+"<tbody>"+'<tr class="'+S+'" height="1">'+'<td height="0" class="'+[j,I].join(" ")+'"></td>'+'<td class="'+T+'" colspan="1">'+'<div class="'+x+'">'+'<div class="'+D+'"></div>'+"</div>"+"</td>"+"</tr>"+'<tr class="'+E+'">'+'<td class="'+[j,R].join(" ")+'"></td>'+"</tr>"+"</tbody>"+"</table>",$='<td class="'+[j,q].join(" ")+'" data-colnumber="{colNumber}">'+'<div class="'+F+'">&nbsp;</div>'+"</td>",J='<div class="'+U+'">{hour}</div>',K='<table cellspacing="0" cellpadding="0" class="'+L+'">'+"<tbody>"+'<tr class="'+N+'"></tr>'+"</tbody>"+"</table>",Q='<th class="'+C+'" data-colnumber="{colNumber}"><a href="#">&nbsp;</a></th>',G='<td class="'+[C,k].join(" ")+'"></td>',Y=e.Component.create({NAME:"scheduler-view-day",ATTRS:{bodyContent:{value:""},days:{value:1,validator:s},delegateConfig:{value:{},setter:function(t){var n=this;return e.merge({dragConfig:{useShim:!1},bubbleTargets:n,container:n.get("boundingBox"),nodes:"."+m,invalid:"input, select, button, a, textarea, ."+g},t||{})},validator:o},eventWidth:{value:95,validator:s},filterFn:{value:function(e){return e.getHoursDuration()<=24&&!e.get("allDay")}},headerDateFormatter:{value:function(t){var n=this,r=n.get("scheduler");return e.DataType.Date.format(t,{format:"<span>%d</span> %a",locale:r.get("locale")})},validator:u},headerView:{value:!0,validator:r},headerViewConfig:{setter:function(t){return e.merge({displayDaysInterval:1,displayRows:6,filterFn:function(e){return e.getHoursDuration()>24||e.get("allDay")},height:"auto",visible:!0},t||{})},value:{}},hourHeight:{value:52,validator:s},name:{value:"day"},navigationDateFormatter:{value:function(t){var n=this,r=n.get("scheduler");return e.DataType.Date.format(t,{format:"%A, %B %d, %Y",locale:r.get("locale")})},validator:i},strings:{value:{allDay:"All day"}},headerTableNode:{valueFn:function(){return e.Node.create(K)}},headerViewLabelNode:{valueFn:function(){var t=this,r=t.get("strings");return e.Node.create(n.sub(X,{label:r.allDay}))}},resizerNode:{valueFn:function(){return e.Node.create(z)}},tableNode:{valueFn:function(){return e.Node.create(V)}},colDaysNode:{valueFn:"_valueColDaysNode"},colHeaderDaysNode:{valueFn:"_valueColHeaderDaysNode"},markercellsNode:{valueFn:"_valueMarkercellsNode"},timesNode:{valueFn:"_valueTimesNode"}},HTML_PARSER:{colDaysNode:c("."+q,1),colHeaderDaysNode:c("."+C,2),headerTableNode:"."+L,headerViewLabelNode:"."+A,markercellsNode:c("."+_,24),resizerNode:"."+P,tableNode:"."+B,timesNode:c("."+U,24)},EXTENDS:e.SchedulerView,prototype:{initializer:function(){var t=this;t.colDaysNode=t.get("colDaysNode"),t.colHeaderDaysNode=t.get("colHeaderDaysNode"),t.headerTableNode=t.get("headerTableNode"),t.markercellsNode=t.get("markercellsNode"),t.resizerNode=t.get("resizerNode"),t.tableNode=t.get("tableNode"),t.timesNode=t.get("timesNode"),t.activeColumn=null,t.columnData=t.tableNode.one("."+E),t.columnDayHeader=t.headerTableNode.one("."+N),t.columnShims=t.colDaysNode.all("."+F),t.columnTime=t.tableNode.one("."+R),t.gridContainer=t.tableNode.one("."+T),t.markersNode=t.tableNode.one("."+D),t.get("headerView")&&(t.headerView=new e.SchedulerTableView(t.get("headerViewConfig")))},renderUI:function(){var e=this;e.columnTime.setContent(e.timesNode),e.markersNode.setContent(e.markercellsNode),e.colDaysNode.appendTo(e.columnData),e.colHeaderDaysNode.appendTo(e.columnDayHeader),e.headerView&&(e.headerView.set("scheduler",e.get("scheduler")),e.headerView.render())},bindUI:function(){var t=this;t.headerTableNode.delegate("click",e.bind(t._onClickDaysHeader,t),"."+C),t.columnData.delegate("mousedown",e.bind(t._onMouseDownTableCol,t),"."+j),t.columnData.delegate("mouseenter",e.bind(t._onMouseEnterEvent,t),"."+m),t.columnData.delegate("mouseleave",e.bind(t._onMouseLeaveEvent,t),"."+m),t.columnData.delegate("mousemove",e.bind(t._onMouseMoveTableCol,t),"."+q),t.columnData.delegate("mouseup",e.bind(t._onMouseUpTableCol,t),"."+j),t.on("drag:end",t._onEventDragEnd),t.on("drag:start",t._onEventDragStart),t.on("drag:tickAlignY"
,t._dragTickAlignY),t.on("schedulerChange",t._onSchedulerChange),t.after("drag:align",t._afterDragAlign)},syncUI:function(){var e=this;Y.superclass.syncUI.apply(this,arguments),e.gridContainer.attr("colspan",e.get("days")),e._setupDragDrop()},syncStdContent:function(){var t=this;t.setStdModContent(f.BODY,t.tableNode.getDOM());var n=e.NodeList.create(t.headerTableNode);t.headerView&&(n.push(t.headerView.get("boundingBox")),n.push(t.get("headerViewLabelNode"))),t.setStdModContent(f.HEADER,n)},calculateEventHeight:function(e){var t=this,n=t.get("hourHeight");return Math.max(e*(n/60),n/2)},calculateTop:function(e){var t=this;return(e.getHours()*60+e.getMinutes()+e.getSeconds()/60)*(t.get("hourHeight")/60)},getNextDate:function(){var e=this,t=e.get("scheduler").get("viewDate");return a.toLastHour(a.add(t,a.DAY,1))},getPrevDate:function(){var e=this,t=e.get("scheduler").get("viewDate");return a.toMidnight(a.subtract(t,a.DAY,1))},getColumnByDate:function(e){var t=this;return t.colDaysNode.item(t.getDateDaysOffset(e))},getColumnShimByDate:function(e){var t=this;return t.columnShims.item(t.getDateDaysOffset(e))},getDateByColumn:function(e){var t=this,n=a.safeClearTime(t.get("scheduler").get("viewDate"));return a.add(n,a.DAY,e)},getDateDaysOffset:function(e){var t=this,n=a.safeClearTime(t.get("scheduler").get("viewDate"));return a.getDayOffset(a.safeClearTime(e),n)},getYCoordTime:function(e){var t=this,n=t.get("hourHeight"),r=p((e/n).toFixed(2)),i=Math.floor(r*100%100*.6),s=Math.floor(r);return[s,i,0]},plotEvent:function(e){var t=this,n=e.get("node");n.size()<2&&e.addPaddingNode();var r=e.get("node").item(0),i=e.get("node").item(1),s=t.getColumnShimByDate(e.get("endDate")),o=t.getColumnShimByDate(e.get("startDate"));o?(o.append(r),e.get("visible")&&r.show()):r.hide(),s?s.compareTo(o)||e.isDayBoundaryEvent()?i.hide():(s.append(i),e.get("visible")&&i.show()):i.hide(),e.syncUI(),t.syncEventTopUI(e),t.syncEventHeightUI(e)},plotEvents:function(){var t=this,n=t.get("scheduler"),r=t.get("filterFn");t.columnShims.each(function(i,s){var o=n.getEventsByDay(t.getDateByColumn(s),!0),u=[];i.empty(),e.Array.each(o,function(e){r.apply(t,[e])&&(t.plotEvent(e),u.push(e))}),t.syncEventsIntersectionUI(u)}),t.syncHeaderViewUI()},syncColumnsUI:function(){var e=this,t=e.get("scheduler").get("todayDate");e.colDaysNode.each(function(n,r){var i=e.getDateByColumn(r);n.toggleClass(b,!a.isDayOverlap(i,t))})},syncDaysHeaderUI:function(){var e=this,t=e.get("scheduler").get("viewDate"),n=e.get("headerDateFormatter"),r=e.get("scheduler").get("todayDate");e.colHeaderDaysNode.all("a").each(function(i,s){var o=a.add(t,a.DAY,s);i.toggleClass(w,!a.isDayOverlap(o,r)),i.html(n.call(e,o))})},syncEventsIntersectionUI:function(t){var n=this,r=n.get("eventWidth");n.get("scheduler").flushEvents(),e.Array.each(t,function(i){var s=n.findEventIntersections(i,t),o=s.length,u=r/o;e.Array.each(s,function(e,t){var n=e.get("node").item(0),i=u*t,s=u*1.7;t===o-1&&(s=r-i),n.setStyle("width",s+"%"),n.setStyle("left",i+"%");var a=n.get("parentNode");a&&a.insert(n,t),e._filtered=!0})})},syncEventHeightUI:function(e){var t=this,n=e.get("endDate"),r=e.get("startDate"),i=a.clone(r);i.setHours(24,0,0);var s=a.getMinutesOffset(t.limitDate(n,i),r);e.get("node").item(0).set("offsetHeight",t.calculateEventHeight(s));var o=e.get("node").item(1);if(o.inDoc()){var u=a.getMinutesOffset(n,a.toMidnight(e.getClearEndDate()));o.set("offsetHeight",t.calculateEventHeight(u))}},syncEventTopUI:function(e){var t=this;e.get("node").item(0).setStyle("top",t.calculateTop(e.get("startDate"))+"px"),e.get("node").item(1).setStyle("top",0)},syncHeaderViewUI:function(){var e=this;if(e.get("headerView")){var t=e.headerView;t.plotEvents(),e.headerNode.setStyle("paddingRight",l());var n=t.get("boundingBox"),r=n.one("."+v),i=Math.max(r.get("offsetHeight"),40);t.set("height",i),e._fillHeight()}},calculateYDelta:function(e,t){var n=this;return(t[1]-e[1])/(n.get("hourHeight")/2)*30},findEventIntersections:function(t,n){var r=[];return e.Array.each(n,function(e){!t._filtered&&e.get("visible")&&t.intersectHours(e)&&r.push(e)}),r},getXYDelta:function(t){var n=t.currentTarget.getXY(),r=[t.pageX,t.pageY];return e.Array.map(n,function(e,t){return r[t]-e})},getTickY:function(){var e=this;return h(Math.ceil(e.get("hourHeight")/2),10)},roundToNearestHour:function(e,t){var n=this;e.setHours(t[0],h(t[1],n.getTickY()),t[2])},_afterDragAlign:function(e){var t=this,n=e.target;t.startXY||(t.startXY=n.actXY),n.actXY[0]=null},_dragTickAlignX:function(e){var t=this,n=t.draggingEvent;if(n&&!t.resizing){var r=t.eventPlaceholder,i=p(e.attr("data-colnumber"))-t.startColNumber;t.draggingEventStartDate=a.add(n.get("startDate"),a.DAY,i);var s=a.clone(t.draggingEventStartDate);a.copyHours(s,r.get("startDate")),r.move(s,{silent:!0}),t.plotEvent(r)}},_dragTickAlignY:function(e){var t=this,n=t.draggingEvent;if(n){var r=e.target.get("host"),i=t.eventPlaceholder,s=t.calculateYDelta(t.startXY,r.actXY);if(t.resizing){var o=a.add(t.draggingEventEndDate,a.MINUTES,s);if(a.getMinutesOffset(o,t.draggingEventStartDate)<30)return;i.set("endDate",o,{silent:!0})}else i.move(a.add(t.draggingEventStartDate,a.MINUTES,s),{silent:!0});t.plotEvent(i)}},_setupDragDrop:function(){var t=this,n=t.eventPlaceholder;if(!n){var r=t.get("scheduler");n=new r.eventModel({scheduler:r}),n.removeTarget(r),n.get("node").addClass(y),n.set("visible",!1,{silent:!0}),t.eventPlaceholder=n}t.delegate||(t.delegate=new e.DD.Delegate(t.get("delegateConfig")));var i=t.delegate.dd;i.unplug(e.Plugin.DDConstrained),i.unplug(e.Plugin.DDNodeScroll);var s=t.bodyNode.get("region");s.bottom=Infinity,s.top=-Infinity,i.plug(e.Plugin.DDConstrained,{bubbleTargets:t,constrain:s,stickY:!0,tickY:t.get("hourHeight")/2}),i.plug(e.Plugin.DDNodeScroll,{node:t.bodyNode,scrollDelay:150})},_uiSetDate:function(){var e=this;e.syncColumnsUI(),e.syncDaysHeaderUI()},_onClickDaysHeader:function(e){var t=this,n=t.get("scheduler");if(e.target.test("a, a span")){var r=n.getViewByName("day");if(
r){var i=p(e.currentTarget.attr("data-colnumber"));n.set("date",t.getDateByColumn(i)),n.set("activeView",r)}}e.preventDefault()},_onEventDragEnd:function(){var e=this,t=e.draggingEvent;if(t){var n=e.eventPlaceholder;n.set("visible",!1,{silent:!0}),t.set("visible",!0,{silent:!0}),t.copyDates(n),e.get("scheduler").syncEventsUI()}e.startXY=null,e.draggingEvent=null},_onEventDragStart:function(){var e=this,t=e.draggingEvent=e.delegate.dd.get("node").getData("scheduler-event");if(t){var n=e.eventPlaceholder;n.copyPropagateAttrValues(t,null,{silent:!0}),e.plotEvent(n),t.set("visible",!1,{silent:!0}),e.draggingEventStartDate=a.clone(t.get("startDate")),e.draggingEventEndDate=a.clone(t.get("endDate"));var r=e.getColumnByDate(t.get("startDate"));e.startColNumber=r?p(r.attr("data-colnumber")):0}},_onMouseDownTableCol:function(e){var t=this,n=e.target,r=t.get("scheduler"),i=r.get("eventRecorder");if(i&&!r.get("disabled")){i.hidePopover();if(n.test("."+F)){t.startXY=[e.pageX,e.pageY];var s=p(e.currentTarget.attr("data-colnumber")),o=t.getDateByColumn(s),u=t.getXYDelta(e);t.roundToNearestHour(o,t.getYCoordTime(u[1]));var f=a.add(o,a.MINUTES,i.get("duration"));i.move(o,{silent:!0}),i.setAttrs({allDay:!1,endDate:f},{silent:!0}),t.creationStartDate=o,e.halt()}else n.test(["."+P,"."+H].join(","))&&(t.resizing=!0)}t.get("boundingBox").unselectable()},_onMouseEnterEvent:function(e){var t=this,n=e.currentTarget,r=n.getData("scheduler-event");r&&!r.get("disabled")&&t.resizerNode.appendTo(n)},_onMouseLeaveEvent:function(){var e=this;e.resizing||e._removeResizer()},_onMouseMoveTableCol:function(e){var t=this,n=e.currentTarget,r=t.get("scheduler").get("eventRecorder");t.activeColumn!==n&&(t.activeColumn=n,t._dragTickAlignX(t.activeColumn));var i=t.creationStartDate;if(i){var s=h(t.calculateYDelta(t.startXY,[e.pageX,e.pageY]),t.getTickY()),o=s>=t._delta;if(t._delta!==s){if(s>0){var u=o?Math.max(s,r.get("duration")):s;r.set("endDate",a.add(i,a.MINUTES,u),{silent:!0})}else r.set("startDate",a.add(i,a.MINUTES,s),{silent:!0});t.plotEvent(r),t._delta=s}}},_onMouseUpTableCol:function(){var e=this,t=e.get("scheduler"),n=t.get("eventRecorder");n&&!t.get("disabled")&&e.creationStartDate&&(e.plotEvent(n),n.showPopover()),e.creationStartDate=null,e.resizing=!1,e.startXY=null,e._removeResizer(),e.get("boundingBox").selectable()},_onSchedulerChange:function(e){var t=this;t.headerView&&t.headerView.set("scheduler",e.newVal)},_removeResizer:function(){var e=this;e.resizerNode.remove()},_valueColDaysNode:function(){var t=this,n=t.get("days"),r=[],i=0;while(n--)r.push(e.Lang.sub($,{colNumber:i++}));return e.NodeList.create(r.join(""))},_valueColHeaderDaysNode:function(){var t=this,n=t.get("days"),r=[],i=0;r.push(G);while(n--)r.push(e.Lang.sub(Q,{colNumber:i++}));return e.NodeList.create(r.join(""))},_valueMarkercellsNode:function(){var t=[],n;for(n=0;n<=23;n++)t.push(W);return e.NodeList.create(t.join(""))},_valueTimesNode:function(){var t=this,r=t.get("isoTime"),i=[],s;for(s=0;s<=23;s++)i.push(n.sub(J,{hour:r?a.toIsoTimeString(s):a.toUsTimeString(s,!1,!0)}));return e.NodeList.create(i.join(""))}}});e.SchedulerDayView=Y},"2.5.0",{requires:["dd-drag","dd-delegate","dd-drop","dd-constrain","aui-scheduler-view-table"],skinnable:!0});
